/* eslint-disable */
import 'isomorphic-fetch';
import { put } from 'redux-saga/effects';
import books from './books/books.json';

import { actions as authActions } from './auth';
import { checkStatus, parseJSON } from './utils';

const baseUrl = 'https://2lzbcfdk9f.execute-api.us-east-1.amazonaws.com/dev';

function getFetchInit(idToken, requestMethod, body) {
  const requestHeaders = new Headers();
  requestHeaders.append('Authorization', `Bearer ${idToken}`);
  requestHeaders.append('Content-Type', 'application/json');

  const fetchInit = {
    method: requestMethod,
    headers: requestHeaders,
  };

  if (body) {
    fetchInit.body = JSON.stringify(body);
  }

  return fetchInit;
}

export function fetchBooks(idToken) {
  // This app reads data from books.json as this is just a demonstration
  // Normally an API call would be made (see below)
  // The API should check validity of idToken and return unauthorised if not valid
  // The app would then prompt the user to log in again

  // return fetch(
  //   `${baseUrl}/v1/books`, getFetchInit(idToken, 'GET'))
  //   .then(checkStatus)
  //   .then(parseJSON)
  //   .then(json => ({ books: json }))
  //   .catch(error => Promise.reject(error));

  return new Promise((resolve) => {
    resolve({
      books: books.sort((a, b) => a.title.localeCompare(b.title)),
    });
  });
}

export function* handleApiError(error, failureAction) {
  const response = error.response;

  if (response === undefined) {
    yield put(failureAction(error.message));
  } else {
    if (response.status === 401) {
      yield put(authActions.loginRequest());
    } else {
      const responseError = {
        status: response.status,
        statusText: response.statusText,
        message: error.message,
      };

      yield put(failureAction(responseError));
    }
  }
}
